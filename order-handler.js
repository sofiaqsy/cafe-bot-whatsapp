/**
 * Order Handler Module (CORREGIDO)
 * Handles the order flow and business logic
 * Mantiene el flujo exacto del bot-final.js original
 */

const stateManager = require('./state-manager');
const messageService = require('./message-service');
const productCatalog = require('./product-catalog');
const config = require('./config');

class OrderHandler {
    constructor() {
        this.orderCounter = 1000;
    }
    
    /**
     * Initialize with services
     */
    initialize(services) {
        this.sheetsService = services.sheets;
        this.driveService = services.drive;
        this.notificationService = services.notifications;
    }
    
    /**
     * Handle incoming message - FLUJO EXACTO DEL ORIGINAL
     */
    async handleMessage(from, body, mediaUrl = null) {
        const mensaje = body.trim();
        let userState = stateManager.getUserState(from);
        
        // Obtener el objeto completo del estado (step + data)
        let fullState = stateManager.getTempOrder(from) || { step: 'inicio', data: {} };
        if (typeof userState === 'string') {
            fullState.step = userState;
        }
        
        // Add to history
        stateManager.addToHistory(from, body, 'user');
        
        console.log(`üì® Estado: ${fullState.step}, Mensaje: ${body}`);
        
        // Comando global: MEN√ö
        if (mensaje.toLowerCase() === 'menu' || mensaje.toLowerCase() === 'men√∫') {
            const pedidosPendientes = stateManager.getPendingOrders(from);
            const tieneHistorial = stateManager.getUserOrders(from).length > 0;
            
            // Construir men√∫ con pedidos pendientes si existen
            const respuesta = this.obtenerMenu(fullState, pedidosPendientes, tieneHistorial);
            
            fullState.step = 'menu_principal';
            stateManager.setUserState(from, 'menu_principal');
            stateManager.setTempOrder(from, fullState);
            return await messageService.sendMessage(from, respuesta);
        }

        // Comando global: CANCELAR
        if (mensaje.toLowerCase() === 'cancelar') {
            let mensajeCancelacion = '';
            if (fullState.data && fullState.data.producto) {
                mensajeCancelacion = `‚ùå Pedido de *${fullState.data.producto.nombre}* cancelado\n\n`;
            }
            fullState = { step: 'menu_principal', data: {} };
            const pedidosPendientes = stateManager.getPendingOrders(from);
            const tieneHistorial = stateManager.getUserOrders(from).length > 0;
            const respuesta = `${mensajeCancelacion}${this.obtenerMenu(fullState, pedidosPendientes, tieneHistorial)}`;
            stateManager.setUserState(from, 'menu_principal');
            stateManager.setTempOrder(from, fullState);
            return await messageService.sendMessage(from, respuesta);
        }

        // Flujo principal
        let respuesta = '';
        
        switch (fullState.step) {
            case 'inicio':
                // Acceso directo con n√∫meros
                if (['1', '2', '3', '4'].includes(mensaje)) {
                    fullState.step = 'menu_principal';
                    stateManager.setUserState(from, 'menu_principal');
                    stateManager.setTempOrder(from, fullState);
                    return this.handleMessage(from, mensaje);
                }
                
                // Acceso con saludos
                if (mensaje.toLowerCase().includes('hola') || 
                    mensaje.toLowerCase().includes('buenas') ||
                    mensaje.toLowerCase().includes('buenos')) {
                    
                    // IMPORTANTE: Obtener pedidos pendientes y mostrarlos en el men√∫
                    const pedidosPendientes = stateManager.getPendingOrders(from);
                    const tieneHistorial = stateManager.getUserOrders(from).length > 0;
                    
                    // Obtener cliente si existe
                    const customer = stateManager.getCustomerData(from);
                    
                    // Construir saludo personalizado con pedidos pendientes
                    let saludoInicial = '';
                    const greeting = this.getGreeting();
                    
                    if (customer && customer.contacto) {
                        saludoInicial = `${greeting} ${customer.contacto}! üëã\n\nBienvenido de vuelta a *${config.business.name}* ‚òï\n\n`;
                    } else {
                        saludoInicial = `${greeting}! üëã\n\nBienvenido a *${config.business.name}* ‚òï\n\n`;
                    }
                    
                    // Si hay pedidos pendientes, mostrarlos primero
                    if (pedidosPendientes && pedidosPendientes.length > 0) {
                        let headerPedidos = `üì¶ *TIENES PEDIDOS PENDIENTES:*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                        
                        pedidosPendientes.forEach(p => {
                            const tiempo = Math.round((new Date() - new Date(p.timestamp || p.fecha)) / (1000 * 60));
                            const tiempoTexto = tiempo < 60 ? `${tiempo} min` : `${Math.round(tiempo/60)} horas`;
                            
                            headerPedidos += `\nüì¶ *${p.id}*\n`;
                            headerPedidos += `   ${p.producto?.nombre || 'Producto'}\n`;
                            headerPedidos += `   ${p.cantidad}kg - S/${p.total}\n`;
                            headerPedidos += `   ‚è≥ Hace ${tiempoTexto}\n`;
                            headerPedidos += `   üì∏ *Env√≠a el comprobante de pago*\n`;
                        });
                        
                        headerPedidos += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
                        
                        // Mensaje completo con pedidos pendientes y men√∫
                        respuesta = saludoInicial + headerPedidos + this.obtenerMenuSimple(tieneHistorial);
                    } else {
                        // Sin pedidos pendientes, mostrar men√∫ normal
                        respuesta = saludoInicial + this.obtenerMenuSimple(tieneHistorial);
                    }
                    
                    fullState.step = 'menu_principal';
                    stateManager.setUserState(from, 'menu_principal');
                    stateManager.setTempOrder(from, fullState);
                } else {
                    // MENSAJE COMPLETO EN UNA SOLA RESPUESTA
                    respuesta = `Hola üëã

Soy el asistente virtual de *${config.business.name}*

Escribe *hola* para ver el men√∫
O env√≠a directamente:
*1* para ver cat√°logo
*2* para consultar pedido
*3* para informaci√≥n`;
                }
                break;
                
            case 'menu_principal':
                const pedidosPendientesMenu = stateManager.getPendingOrders(from);
                const tieneHistorialMenu = stateManager.getUserOrders(from).length > 0;
                
                switch (mensaje) {
                    case '1':
                        respuesta = this.mostrarCatalogo(fullState);
                        fullState.step = 'seleccion_producto';
                        break;
                        
                    case '2':
                        respuesta = `üîç *CONSULTAR PEDIDO*

Por favor, ingresa tu c√≥digo de pedido
_Ejemplo: CAF-123456_

Escribe *menu* para volver`;
                        fullState.step = 'consulta_pedido';
                        break;
                        
                    case '3':
                        respuesta = `‚ÑπÔ∏è *INFORMACI√ìN*

*${config.business.name}*
_Importadores de caf√© peruano premium_

üì± WhatsApp: ${config.business.phone}
üìß Email: ${config.business.email}
üïí Horario: ${config.business.horario}
üìç Lima, Per√∫

*Servicios:*
‚Ä¢ Venta al por mayor (m√≠n. 5kg)
‚Ä¢ Entregas a todo Lima
‚Ä¢ Productos certificados

*M√©todo de pago:*
üí≥ Transferencia bancaria

Escribe *menu* para volver`;
                        fullState.step = 'info_mostrada';
                        break;
                        
                    case '4':
                        if (tieneHistorialMenu) {
                            respuesta = this.mostrarHistorialPedidos(from);
                            fullState.step = 'seleccionar_reorden';
                        } else {
                            respuesta = `Por favor, env√≠a un n√∫mero v√°lido:

*1* - Ver cat√°logo
*2* - Consultar pedido
*3* - Informaci√≥n`;
                        }
                        break;
                        
                    default:
                        respuesta = `Por favor, env√≠a un n√∫mero v√°lido:

*1* - Ver cat√°logo
*2* - Consultar pedido
*3* - Informaci√≥n${tieneHistorialMenu ? '\n*4* - Volver a pedir' : ''}`;
                }
                break;
                
            case 'seleccion_producto':
                const producto = productCatalog.getProduct(mensaje);
                if (producto) {
                    let mensajeCambio = '';
                    if (fullState.data && fullState.data.producto && fullState.data.producto.id !== producto.id) {
                        mensajeCambio = `_Cambiando de ${fullState.data.producto.nombre} a ${producto.nombre}_\n\n`;
                    }
                    
                    fullState.data.producto = producto;
                    delete fullState.data.cantidad;
                    delete fullState.data.total;
                    
                    respuesta = `${mensajeCambio}‚úÖ Has seleccionado:
*${producto.nombre}*

üìç Origen: ${producto.origen}
üéØ Notas: ${producto.descripcion}
üí∞ Precio: ${this.formatearPrecio(producto.precio)}/kg

*¬øCu√°ntos kilos necesitas?*
_Pedido m√≠nimo: 5kg_`;
                    fullState.step = 'cantidad_producto';
                } else if (mensaje.toLowerCase() === 'menu' || mensaje.toLowerCase() === 'men√∫') {
                    return this.handleMessage(from, 'menu');
                } else {
                    respuesta = `‚ùå Por favor, selecciona un producto v√°lido (1-5)

O escribe *menu* para volver al men√∫`;
                }
                break;
                
            case 'cantidad_producto':
                const cantidad = parseFloat(mensaje);
                
                if (!isNaN(cantidad) && cantidad >= config.business.deliveryMin) {
                    fullState.data.cantidad = cantidad;
                    const total = cantidad * fullState.data.producto.precio;
                    fullState.data.total = total;

                    respuesta = `üìä *RESUMEN DEL PEDIDO*

üì¶ *${fullState.data.producto.nombre}*
‚öñÔ∏è Cantidad: *${cantidad} kg*
üíµ Precio unitario: ${this.formatearPrecio(fullState.data.producto.precio)}/kg

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üí∞ *TOTAL: ${this.formatearPrecio(total)}*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

*¬øConfirmar pedido?*
Env√≠a *SI* para continuar
Env√≠a *NO* para cancelar
Env√≠a *MENU* para volver`;
                    fullState.step = 'confirmar_pedido';
                } else if (!isNaN(cantidad) && cantidad < config.business.deliveryMin) {
                    respuesta = `‚ùå El pedido m√≠nimo es de *5kg*

Has ingresado: ${cantidad}kg

Por favor, ingresa una cantidad de 5kg o m√°s:`;
                } else {
                    respuesta = `‚ùå Por favor, ingresa una cantidad v√°lida en n√∫meros.

_Ejemplo: 10_

M√≠nimo: 5kg`;
                }
                break;
                
            case 'confirmar_pedido':
                if (mensaje.toLowerCase() === 'si' || mensaje.toLowerCase() === 's√≠') {
                    // Verificar si ya tenemos datos del cliente
                    const datosGuardados = stateManager.getCustomerData(from);
                    
                    if (datosGuardados) {
                        // Ya tenemos los datos, usar los guardados
                        fullState.data = {
                            ...fullState.data,
                            ...datosGuardados
                        };
                        
                        // Ir directo al pago
                        respuesta = `‚úÖ *PEDIDO CONFIRMADO*

Usando tus datos registrados:
üè¢ ${datosGuardados.empresa}
üìç ${datosGuardados.direccion}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

*M√âTODO DE PAGO*
üí≥ Realiza la transferencia a:

*Cuenta BCP Soles:*
*${config.business.banking.bcpCuenta}*

*Cuenta Interbancaria (CCI):*
*${config.business.banking.cciCuenta}*

*Titular:* ${config.business.name}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üí∞ *Monto a transferir: ${this.formatearPrecio(fullState.data.total)}*

üì∏ *Una vez realizada la transferencia, env√≠a la foto del voucher o comprobante*

_El pedido ser√° confirmado tras verificar el pago_`;
                        
                        fullState.step = 'esperando_comprobante';
                    } else {
                        // Primera vez, pedir datos - NO PEDIR EMAIL
                        respuesta = `üë§ *DATOS DEL CLIENTE*

Por favor, ingresa el *nombre de tu empresa o negocio*:`;
                        fullState.step = 'datos_empresa';
                    }
                } else if (mensaje.toLowerCase() === 'no') {
                    fullState.data = {};
                    respuesta = `‚ùå Pedido cancelado.

üì± *MEN√ö PRINCIPAL*

*1* - Ver cat√°logo
*2* - Consultar pedido
*3* - Informaci√≥n

Env√≠a el n√∫mero de tu elecci√≥n`;
                    fullState.step = 'menu_principal';
                } else if (mensaje.toLowerCase() === 'menu' || mensaje.toLowerCase() === 'men√∫') {
                    return this.handleMessage(from, 'menu');
                } else {
                    respuesta = `Por favor, responde:

*SI* - Confirmar pedido
*NO* - Cancelar
*MENU* - Volver al men√∫`;
                }
                break;
                
            case 'datos_empresa':
                fullState.data.empresa = mensaje;
                respuesta = `‚úÖ Empresa: *${mensaje}*

Ahora ingresa el *nombre del contacto*:`;
                fullState.step = 'datos_contacto';
                break;
                
            case 'datos_contacto':
                fullState.data.contacto = mensaje;
                respuesta = `‚úÖ Contacto: *${mensaje}*

Ingresa tu *n√∫mero de tel√©fono*:`;
                fullState.step = 'datos_telefono';
                break;
                
            case 'datos_telefono':
                fullState.data.telefono = mensaje;
                respuesta = `‚úÖ Tel√©fono: *${mensaje}*

Ingresa la *direcci√≥n de entrega completa*:
_Incluye distrito y referencia_`;
                fullState.step = 'datos_direccion';
                break;
                
            case 'datos_direccion':
                fullState.data.direccion = mensaje;
                
                // Generar ID del pedido
                const pedidoTempId = 'CAF-' + Date.now().toString().slice(-6);
                fullState.data.pedidoTempId = pedidoTempId;
                
                // Guardar datos del cliente para futuros pedidos - SIN EMAIL
                stateManager.setCustomerData(from, {
                    empresa: fullState.data.empresa,
                    contacto: fullState.data.contacto,
                    telefono: fullState.data.telefono,
                    direccion: fullState.data.direccion
                });
                
                respuesta = `‚úÖ Direcci√≥n guardada: *${mensaje}*

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

*M√âTODO DE PAGO*
üí≥ Realiza la transferencia a:

*Cuenta BCP Soles:*
*${config.business.banking.bcpCuenta}*

*Cuenta Interbancaria (CCI):*
*${config.business.banking.cciCuenta}*

*Titular:* ${config.business.name}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üí∞ *Monto a transferir: ${this.formatearPrecio(fullState.data.total)}*

üì∏ *ENV√çO DE COMPROBANTE:*
${this.driveService ? 
`‚úÖ *Env√≠a la foto del comprobante por WhatsApp*
_La imagen se guardar√° autom√°ticamente_` : 
`*Opci√≥n 1 - Formulario Web üåê:*
${config.business.forms.comprobantes}
_Sube tu imagen desde el tel√©fono_`}

*Opci√≥n alternativa:*
_Escribe *"listo"* o *"enviado"* para confirmar_

üí° *Tu c√≥digo de pedido es: ${pedidoTempId}*`;
                
                fullState.step = 'esperando_comprobante';
                break;
                
            case 'seleccionar_reorden':
                const historialReorden = stateManager.getUserOrders(from).slice(0, 5);
                const indice = parseInt(mensaje) - 1;
                
                if (indice >= 0 && indice < historialReorden.length) {
                    const pedidoAnterior = historialReorden[indice];
                    
                    // Copiar datos del pedido anterior
                    fullState.data = {
                        producto: pedidoAnterior.producto,
                        cantidad: pedidoAnterior.cantidad,
                        total: pedidoAnterior.total,
                        empresa: pedidoAnterior.empresa,
                        contacto: pedidoAnterior.contacto,
                        telefono: pedidoAnterior.telefono,
                        direccion: pedidoAnterior.direccion,
                        esReorden: true
                    };
                    
                    // Guardar datos del cliente para futuros pedidos
                    stateManager.setCustomerData(from, {
                        empresa: pedidoAnterior.empresa,
                        contacto: pedidoAnterior.contacto,
                        telefono: pedidoAnterior.telefono,
                        direccion: pedidoAnterior.direccion
                    });
                    
                    respuesta = `üîÑ *REPETIR PEDIDO*

üì¶ *${pedidoAnterior.producto.nombre}*
‚öñÔ∏è Cantidad: *${pedidoAnterior.cantidad} kg*
üí∞ Total: *${this.formatearPrecio(pedidoAnterior.total)}*

*DATOS DE ENTREGA:*
üè¢ ${pedidoAnterior.empresa}
üìç ${pedidoAnterior.direccion}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

*M√âTODO DE PAGO*
üí≥ Realiza la transferencia a:

*Cuenta BCP Soles:*
*${config.business.banking.bcpCuenta}*

*Cuenta Interbancaria (CCI):*
*${config.business.banking.cciCuenta}*

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üí∞ *Monto a transferir: ${this.formatearPrecio(pedidoAnterior.total)}*

üì∏ *Env√≠a la foto del voucher o comprobante*

_El pedido ser√° confirmado tras verificar el pago_`;
                    
                    fullState.step = 'esperando_comprobante';
                } else {
                    respuesta = `‚ùå Por favor, selecciona un n√∫mero v√°lido de la lista.

_Escribe *menu* para volver_`;
                }
                break;
                
            case 'esperando_comprobante':
                // Si hay una imagen
                if (mediaUrl) {
                    respuesta = await this.procesarComprobante(from, fullState, mediaUrl);
                    fullState = { step: 'pedido_completado', data: {} };
                } 
                // Si es confirmaci√≥n por texto
                else if (mensaje.toLowerCase().includes('listo') ||
                         mensaje.toLowerCase().includes('enviado') ||
                         mensaje.toLowerCase() === 'ok' ||
                         mensaje === '‚úÖ') {
                    respuesta = await this.procesarComprobante(from, fullState, null);
                    fullState = { step: 'pedido_completado', data: {} };
                }
                // Si cancela
                else if (mensaje.toLowerCase() === 'cancelar') {
                    fullState.data = {};
                    respuesta = `‚ùå Proceso de pago cancelado.

üì± *MEN√ö PRINCIPAL*

*1* - Ver cat√°logo
*2* - Consultar pedido
*3* - Informaci√≥n

Env√≠a el n√∫mero de tu elecci√≥n`;
                    fullState.step = 'menu_principal';
                } 
                // Recordatorio
                else {
                    respuesta = `üì∏ *Por favor, env√≠a la foto del comprobante de transferencia*

‚ö†Ô∏è Si no puedes enviar la imagen ahora, escribe *"listo"* o *"enviado"* despu√©s de realizar la transferencia.

_O escribe *cancelar* para cancelar el proceso_`;
                }
                break;
                
            default:
                // Estado desconocido, reiniciar
                fullState = { step: 'inicio', data: {} };
                respuesta = `Hola üëã

Soy el asistente virtual de *${config.business.name}*

Escribe *hola* para ver el men√∫
O env√≠a directamente:
*1* para ver cat√°logo
*2* para consultar pedido
*3* para informaci√≥n`;
        }
        
        // Guardar estado actualizado
        stateManager.setUserState(from, fullState.step);
        stateManager.setTempOrder(from, fullState);
        
        // Enviar respuesta
        await messageService.sendMessage(from, respuesta);
    }
    
    /**
     * Obtener men√∫ con pedidos pendientes
     */
    obtenerMenu(userState, pedidosPendientes, tieneHistorial) {
        let headerPedidos = '';
        
        // Mostrar pedidos pendientes si existen
        if (pedidosPendientes && pedidosPendientes.length > 0) {
            headerPedidos = `üì¶ *PEDIDOS PENDIENTES:*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            
            pedidosPendientes.forEach(p => {
                const tiempo = Math.round((new Date() - new Date(p.timestamp || p.fecha)) / (1000 * 60));
                const tiempoTexto = tiempo < 60 ? `${tiempo} min` : `${Math.round(tiempo/60)} horas`;
                
                headerPedidos += `üì¶ *${p.id}*
   ${p.producto?.nombre || 'Producto'}
   ${p.cantidad}kg - ${this.formatearPrecio(p.total)}
   ‚è≥ Hace ${tiempoTexto}
   
`;
            });
            
            headerPedidos += `üí° _Consulta el estado con el c√≥digo_
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

`;
        }
        
        // Si hay un pedido en proceso, mostrarlo
        if (userState.data && userState.data.producto) {
            const cantidadStr = userState.data.cantidad ? `${userState.data.cantidad}kg` : 'cantidad por definir';
            const totalStr = userState.data.total ? this.formatearPrecio(userState.data.total) : 'por calcular';
            
            headerPedidos += `üõí *PEDIDO ACTUAL:*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üì¶ ${userState.data.producto.nombre}
‚öñÔ∏è Cantidad: ${cantidadStr}
üí∞ Total: ${totalStr}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üí° _Escribe *cancelar* para eliminar el pedido_

`;
        }
        
        // Agregar opci√≥n de reordenar si tiene historial
        const opcionReordenar = tieneHistorial ? 
            `*4* - Volver a pedir üîÑ\n` : '';
        
        return `${headerPedidos}üì± *MEN√ö PRINCIPAL*

*1* - Ver cat√°logo y pedir ‚òï
*2* - Consultar pedido üì¶
*3* - Informaci√≥n del negocio ‚ÑπÔ∏è
${opcionReordenar}
Env√≠a el n√∫mero de tu elecci√≥n`;
    }
    
    /**
     * Mostrar cat√°logo
     */
    mostrarCatalogo(userState) {
        let headerCatalogo = '';
        if (userState.data && userState.data.producto) {
            headerCatalogo = `üîÑ *Tienes un pedido en proceso*
${userState.data.producto.nombre} - ${userState.data.cantidad || '?'}kg

_Selecciona un nuevo producto para reemplazarlo_
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

`;
        }
        
        return `${headerCatalogo}‚òï *CAT√ÅLOGO DE CAF√â*

*1. Premium* - S/50/kg
   üìç Chanchamayo
   üéØ Chocolate y frutos rojos

*2. Est√°ndar* - S/40/kg
   üìç Satipo
   üéØ Caramelo y nueces

*3. Org√°nico* ‚úÖ - S/60/kg
   üìç Villa Rica
   üéØ Floral y c√≠trico

*4. Mezcla Especial* - S/35/kg
   üìç Blend peruano
   üéØ Ideal para espresso

*5. Descafeinado* - S/45/kg
   üìç Cusco
   üéØ Suave sin cafe√≠na

üì¶ *Pedido m√≠nimo: 5kg*

*Env√≠a el n√∫mero del producto que deseas*
_Escribe *menu* para volver_`;
    }
    
    /**
     * Mostrar historial de pedidos
     */
    mostrarHistorialPedidos(from) {
        const historial = stateManager.getUserOrders(from).slice(0, 5);
        let respuesta = `üîÑ *TUS PEDIDOS ANTERIORES*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

`;
        historial.forEach((p, index) => {
            const fecha = new Date(p.timestamp || p.fecha).toLocaleDateString('es-PE');
            respuesta += `*${index + 1}.* ${p.producto?.nombre || 'Producto'}
   üì¶ ${p.cantidad}kg - ${this.formatearPrecio(p.total)}
   üìÖ ${fecha}
   ${p.status === 'Confirmado' ? '‚úÖ' : '‚è≥'} ${p.status || p.estado}

`;
        });
        
        respuesta += `*Env√≠a el n√∫mero del pedido que deseas repetir*

_O escribe *menu* para volver_`;
        
        return respuesta;
    }
    
    /**
     * Procesar comprobante
     */
    async procesarComprobante(from, userState, mediaUrl) {
        const pedidoId = userState.data.pedidoTempId || 'CAF-' + Date.now().toString().slice(-6);
        
        const pedidoCompleto = {
            id: pedidoId,
            fecha: new Date(),
            timestamp: new Date(),
            producto: userState.data.producto,
            cantidad: userState.data.cantidad,
            total: userState.data.total,
            empresa: userState.data.empresa,
            contacto: userState.data.contacto,
            telefono: userState.data.telefono || from,
            direccion: userState.data.direccion,
            metodoPago: 'Transferencia bancaria',
            status: 'Pendiente verificaci√≥n',
            estado: 'Pendiente verificaci√≥n',
            comprobanteRecibido: true,
            esReorden: userState.data.esReorden || false,
            urlComprobante: mediaUrl || null,
            userId: from
        };
        
        // Guardar pedido
        stateManager.addConfirmedOrder(pedidoId, pedidoCompleto);
        
        // Guardar en Sheets si est√° disponible
        if (this.sheetsService) {
            try {
                await this.sheetsService.saveOrder(pedidoCompleto);
            } catch (error) {
                console.error('Error guardando en Sheets:', error);
            }
        }
        
        // Guardar imagen en Drive si est√° disponible
        if (this.driveService && mediaUrl) {
            try {
                const imageUrl = await this.driveService.saveImage(mediaUrl, pedidoId);
                console.log('üì∏ Comprobante guardado:', imageUrl);
            } catch (error) {
                console.error('Error guardando en Drive:', error);
            }
        }
        
        // Notificar admin
        if (this.notificationService) {
            await this.notificationService.notifyNewOrder(pedidoCompleto);
        }
        
        return `üì∏ *¬°COMPROBANTE RECIBIDO!*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚úÖ Tu pedido ha sido registrado exitosamente

üìã *C√≥digo de pedido:* ${pedidoId}
üìÖ *Fecha:* ${new Date().toLocaleDateString('es-PE')}

*RESUMEN DEL PEDIDO:*
üì¶ ${userState.data.producto.nombre}
‚öñÔ∏è ${userState.data.cantidad}kg
üí∞ Total: ${this.formatearPrecio(userState.data.total)}

*DATOS DE ENTREGA:*
üè¢ ${userState.data.empresa}
üë§ ${userState.data.contacto}
üì± ${userState.data.telefono}
üìç ${userState.data.direccion}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚è≥ *ESTADO:* Pendiente de verificaci√≥n

üîç *Pr√≥ximos pasos:*
1Ô∏è‚É£ Verificaremos tu pago (m√°x. 30 min)
2Ô∏è‚É£ Te confirmaremos por este medio
3Ô∏è‚É£ Coordinaremos la entrega (24-48h)

üí° *Guarda tu c√≥digo: ${pedidoId}*

Puedes consultar el estado con tu c√≥digo en cualquier momento.

¬°Gracias por tu compra! ‚òï

_Escribe *menu* para realizar otro pedido_`;
    }
    
    /**
     * Obtener men√∫ simple (solo opciones, sin pedidos)
     */
    obtenerMenuSimple(tieneHistorial) {
        const opcionReordenar = tieneHistorial ? 
            `*4* - Volver a pedir üîÑ\n` : '';
        
        return `üì± *MEN√ö PRINCIPAL*

*1* - Ver cat√°logo y pedir ‚òï
*2* - Consultar pedido üì¶
*3* - Informaci√≥n del negocio ‚ÑπÔ∏è
${opcionReordenar}
Env√≠a el n√∫mero de tu elecci√≥n`;
    }
    
    /**
     * Obtener saludo seg√∫n la hora
     */
    getGreeting() {
        const hour = new Date().getHours();
        if (hour < 12) return 'Buenos d√≠as';
        if (hour < 18) return 'Buenas tardes';
        return 'Buenas noches';
    }
    
    /**
     * Formatear precio
     */
    formatearPrecio(precio) {
        return `S/ ${precio.toFixed(2)}`;
    }
    
    /**
     * Generate unique order ID
     */
    generateOrderId() {
        const prefix = 'CAF';
        const timestamp = Date.now().toString().slice(-6);
        return `${prefix}-${timestamp}`;
    }
}

// Export singleton instance
module.exports = new OrderHandler();
