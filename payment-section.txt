            case 'datos_telefono':
                userState.data.telefono = mensaje;
                respuesta = `âœ… TelÃ©fono: *${mensaje}*

Ingresa la *direcciÃ³n de entrega completa*:
_Incluye distrito y referencia_`;
                userState.step = 'datos_direccion';
                break;

            case 'datos_direccion':
                userState.data.direccion = mensaje;
                
                // Generar ID Ãºnico
                const pedidoId = 'CAF-' + Date.now().toString().slice(-6);
                
                const pedidoCompleto = {
                    id: pedidoId,
                    fecha: new Date(),
                    producto: userState.data.producto,
                    cantidad: userState.data.cantidad,
                    total: userState.data.total,
                    empresa: userState.data.empresa,
                    contacto: userState.data.contacto,
                    telefono: userState.data.telefono,
                    direccion: userState.data.direccion,
                    metodoPago: 'Transferencia bancaria',
                    estado: 'Confirmado'
                };
                
                pedidosConfirmados.set(pedidoId, pedidoCompleto);

                // Guardar en Google Sheets si estÃ¡ configurado
                if (sheetsConfigured && googleSheets && googleSheets.initialized) {
                    try {
                        await googleSheets.agregarPedido({
                            id: pedidoId,
                            nombreNegocio: userState.data.empresa,
                            cafeteria: userState.data.empresa,
                            producto: userState.data.producto,
                            cantidad: userState.data.cantidad,
                            subtotal: userState.data.total,
                            descuento: 0,
                            total: userState.data.total,
                            direccion: userState.data.direccion,
                            contacto: `${userState.data.contacto} - ${userState.data.telefono}`,
                            telefono: from,
                            metodoPago: 'Transferencia bancaria',
                            observaciones: '',
                            estado: 'Confirmado'
                        });
                        console.log('âœ… Pedido guardado en Google Sheets');
                    } catch (error) {
                        console.error('âš ï¸ Error guardando en Google Sheets:', error.message);
                    }
                }

                respuesta = `âœ… *Â¡PEDIDO CONFIRMADO!*
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“‹ *CÃ³digo:* ${pedidoId}
ğŸ“… *Fecha:* ${new Date().toLocaleDateString('es-PE')}

*RESUMEN:*
ğŸ“¦ ${userState.data.producto.nombre}
âš–ï¸ ${userState.data.cantidad}kg
ğŸ’° *Total: ${formatearPrecio(userState.data.total)}*

*CLIENTE:*
ğŸ¢ ${userState.data.empresa}
ğŸ‘¤ ${userState.data.contacto}
ğŸ“± ${userState.data.telefono}
ğŸ“ ${userState.data.direccion}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

*MÃ‰TODO DE PAGO*
ğŸ’³ Transferencia a la siguiente cuenta:

*Mi nÃºmero de cuenta BCP Soles es:*
*1917137473085*

*Mi nÃºmero de cuenta interbancaria es:*
*00219100713747308552*

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â° *Entrega:* 24-48 horas
ğŸ“ Te contactaremos para confirmar el pago

ğŸ’¡ *Guarda tu cÃ³digo ${pedidoId}*

Â¡Gracias por tu compra! â˜•

_Escribe *menu* para nuevo pedido_`;
                
                userState = { step: 'pedido_completado', data: {} };
                break;
